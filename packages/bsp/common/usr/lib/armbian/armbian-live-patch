#!/bin/bash
#

echo "Armbian live patch"

PATCH="https://dl.armbian.com/_patch/pre-apt-upgrade.sh"
PATCH_SIG="https://dl.armbian.com/_patch/pre-apt-upgrade.sh.sig"

TMP_DIR=$(mktemp -d -t test-XXXX)
wget -q --retry-connrefused --waitretry=1 --read-timeout=20 --timeout=15 -t 3 ${PATCH} -P ${TMP_DIR}
wget -q --retry-connrefused --waitretry=1 --read-timeout=20 --timeout=15 -t 3 ${PATCH_SIG} -P ${TMP_DIR}

# Check if file is signed with Armbian key
gpg --keyring /usr/share/keyrings/armbian.gpg --verify ${TMP_DIR}/${PATCH_SIG##*/} ${TMP_DIR}/${PATCH##*/} > ${TMP_DIR}/live-patch.log 2> /var/log/armbian-preinstall-patch.log

if [[ $? == 0 ]]; then
        echo "Patch file is signed with Armbian GPG key"
        echo "Running Armbian Live Patch"
        bash ${TMP_DIR}/${PATCH##*/} >> /var/log/armbian-preinstall-patch.log
        rm -rf ${TMP_DIR}/${PATCH##*/}
fi

exit 0
